{% extends "base.html" %}

{% block title %}Edit PDF Text - RevisePDF{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0">Edit PDF Text</h2>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        Edit existing text directly on your PDF document while preserving formatting. You can also add new text, images, or remove content.
                    </p>

                    <form id="upload-form" method="POST" enctype="multipart/form-data">
                        {{ form.csrf_token }}

                        <div class="mb-3">
                            {{ form.file.label(class="form-label") }}
                            {{ form.file(class="form-control") }}
                            {% if form.file.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.file.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Upload PDF</button>
                        </div>
                    </form>
                </div>
            </div>

            {% if pdf_uploaded %}
            <div class="card mt-4">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">PDF Text Editor</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="pdf-preview-container border mb-3">
                                <img id="pdf-preview" src="data:image/png;base64,{{ preview_image }}" class="img-fluid" alt="PDF Preview">
                                <div id="editor-overlay"></div>
                            </div>

                            <div class="d-flex justify-content-between mb-3">
                                <div>
                                    <button id="prev-page" class="btn btn-outline-secondary" {% if current_page <= 1 %}disabled{% endif %}>
                                        <i class="fas fa-chevron-left"></i> Previous
                                    </button>
                                    <button id="next-page" class="btn btn-outline-secondary" {% if current_page >= total_pages %}disabled{% endif %}>
                                        Next <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                <div>
                                    <span class="page-info">Page {{ current_page }} of {{ total_pages }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">Editing Tools</h5>
                                </div>
                                <div class="card-body">
                                    <ul class="nav nav-tabs" id="editorTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="edit-text-tab" data-bs-toggle="tab" data-bs-target="#edit-text-panel" type="button" role="tab" aria-controls="edit-text-panel" aria-selected="true">Edit Text</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="text-tab" data-bs-toggle="tab" data-bs-target="#text-panel" type="button" role="tab" aria-controls="text-panel" aria-selected="false">Add Text</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="image-tab" data-bs-toggle="tab" data-bs-target="#image-panel" type="button" role="tab" aria-controls="image-panel" aria-selected="false">Add Image</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="erase-tab" data-bs-toggle="tab" data-bs-target="#erase-panel" type="button" role="tab" aria-controls="erase-panel" aria-selected="false">Erase Content</button>
                                        </li>
                                    </ul>

                                    <div class="tab-content p-3 border border-top-0 rounded-bottom" id="editorTabContent">
                                        <!-- Edit Text Tab -->
                                        <div class="tab-pane fade show active" id="edit-text-panel" role="tabpanel" aria-labelledby="edit-text-tab">
                                            <div class="mb-3">
                                                <div class="alert alert-info">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    <strong>How to edit text:</strong> Click directly on text in the PDF to select and edit it. Your changes will preserve the original text formatting.
                                                </div>
                                                <div id="text-selection-info" class="alert alert-light border d-none">
                                                    <p class="mb-1"><strong>Selected Text:</strong></p>
                                                    <p id="selected-text" class="mb-2 text-truncate"></p>
                                                    <div class="mb-3">
                                                        <label for="edit-text-content" class="form-label">New Text</label>
                                                        <textarea id="edit-text-content" class="form-control" rows="3"></textarea>
                                                    </div>
                                                    <div class="d-grid">
                                                        <button id="apply-text-edit" class="btn btn-primary">Apply Changes</button>
                                                    </div>
                                                </div>
                                                <div id="no-text-selected" class="alert alert-warning">
                                                    No text selected. Click on text in the PDF to edit it.
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Add Text Tab -->
                                        <div class="tab-pane fade" id="text-panel" role="tabpanel" aria-labelledby="text-tab">
                                            <form id="add-text-form" method="POST" action="{{ url_for('edit.add_text') }}">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <input type="hidden" name="page_number" value="{{ current_page }}">
                                                <input type="hidden" name="filename" value="{{ filename }}">

                                                <div class="mb-3">
                                                    <label for="text-content" class="form-label">Text</label>
                                                    <textarea id="text-content" name="text" class="form-control" rows="3" required></textarea>
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="font-name" class="form-label">Font</label>
                                                        <select id="font-name" name="font_name" class="form-select">
                                                            {% for font in available_fonts %}
                                                                <option value="{{ font }}">{{ font }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="font-size" class="form-label">Size</label>
                                                        <input type="number" id="font-size" name="font_size" class="form-control" value="12" min="6" max="72">
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="text-color" class="form-label">Color</label>
                                                        <input type="color" id="text-color" name="color" class="form-control form-control-color" value="#000000">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="text-align" class="form-label">Align</label>
                                                        <select id="text-align" name="align" class="form-select">
                                                            <option value="left">Left</option>
                                                            <option value="center">Center</option>
                                                            <option value="right">Right</option>
                                                        </select>
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="text-x" class="form-label">X Position</label>
                                                        <input type="number" id="text-x" name="x" class="form-control" value="100" min="0" max="{{ pdf_width }}">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="text-y" class="form-label">Y Position</label>
                                                        <input type="number" id="text-y" name="y" class="form-control" value="100" min="0" max="{{ pdf_height }}">
                                                    </div>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="text-rotate" class="form-label">Rotation (degrees)</label>
                                                    <input type="number" id="text-rotate" name="rotate" class="form-control" value="0" min="0" max="360">
                                                </div>

                                                <div class="d-grid">
                                                    <button type="submit" class="btn btn-primary">Add Text</button>
                                                </div>
                                            </form>
                                        </div>



                                        <!-- Image Tab -->
                                        <div class="tab-pane fade" id="image-panel" role="tabpanel" aria-labelledby="image-tab">
                                            <form id="add-image-form" method="POST" action="{{ url_for('edit.add_image') }}" enctype="multipart/form-data">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <input type="hidden" name="page_number" value="{{ current_page }}">
                                                <input type="hidden" name="filename" value="{{ filename }}">

                                                <div class="mb-3">
                                                    <label for="image-file" class="form-label">Image File</label>
                                                    <input type="file" id="image-file" name="image" class="form-control" accept="image/*" required>
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="image-x" class="form-label">X Position</label>
                                                        <input type="number" id="image-x" name="x" class="form-control" value="100" min="0" max="{{ pdf_width }}">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="image-y" class="form-label">Y Position</label>
                                                        <input type="number" id="image-y" name="y" class="form-control" value="100" min="0" max="{{ pdf_height }}">
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="image-width" class="form-label">Width</label>
                                                        <input type="number" id="image-width" name="width" class="form-control" value="200" min="10" max="{{ pdf_width }}">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="image-height" class="form-label">Height</label>
                                                        <input type="number" id="image-height" name="height" class="form-control" value="200" min="10" max="{{ pdf_height }}">
                                                    </div>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="image-rotate" class="form-label">Rotation (degrees)</label>
                                                    <input type="number" id="image-rotate" name="rotate" class="form-control" value="0" min="0" max="360">
                                                </div>

                                                <div class="d-grid">
                                                    <button type="submit" class="btn btn-primary">Add Image</button>
                                                </div>
                                            </form>
                                        </div>

                                        <!-- Erase Tab -->
                                        <div class="tab-pane fade" id="erase-panel" role="tabpanel" aria-labelledby="erase-tab">
                                            <form id="erase-content-form" method="POST" action="{{ url_for('edit.remove_content') }}">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <input type="hidden" name="page_number" value="{{ current_page }}">
                                                <input type="hidden" name="filename" value="{{ filename }}">

                                                <div class="alert alert-warning">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                                    This will permanently remove content from the selected area by covering it with a white rectangle.
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="erase-x1" class="form-label">X1 (Top-Left)</label>
                                                        <input type="number" id="erase-x1" name="x1" class="form-control" value="100" min="0" max="{{ pdf_width }}">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="erase-y1" class="form-label">Y1 (Top-Left)</label>
                                                        <input type="number" id="erase-y1" name="y1" class="form-control" value="100" min="0" max="{{ pdf_height }}">
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="erase-x2" class="form-label">X2 (Bottom-Right)</label>
                                                        <input type="number" id="erase-x2" name="x2" class="form-control" value="300" min="0" max="{{ pdf_width }}">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="erase-y2" class="form-label">Y2 (Bottom-Right)</label>
                                                        <input type="number" id="erase-y2" name="y2" class="form-control" value="300" min="0" max="{{ pdf_height }}">
                                                    </div>
                                                </div>

                                                <div class="d-grid">
                                                    <button type="submit" class="btn btn-danger">Erase Content</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid">
                                <a href="{{ url_for('edit.download_edited', filename=output_filename) }}" class="btn btn-success mb-3">Download Edited PDF</a>
                                <a href="{{ url_for('edit.content') }}" class="btn btn-outline-secondary">Start Over</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="card mt-4">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">About PDF Content Editing</h3>
                </div>
                <div class="card-body">
                    <p>
                        PDF content editing allows you to:
                    </p>

                    <ul>
                        <li>Add text with custom fonts, sizes, and colors</li>
                        <li>Insert images at specific positions</li>
                        <li>Remove unwanted content by covering it with white rectangles</li>
                        <li>Make quick adjustments without needing specialized PDF software</li>
                    </ul>

                    <h4>Editing Tips</h4>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">Adding Text</h5>
                                </div>
                                <div class="card-body">
                                    <ul>
                                        <li>Use standard fonts for better compatibility</li>
                                        <li>Position text using X/Y coordinates</li>
                                        <li>Adjust font size for readability</li>
                                        <li>Use rotation for creative layouts</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">Adding Images</h5>
                                </div>
                                <div class="card-body">
                                    <ul>
                                        <li>Use PNG for transparent backgrounds</li>
                                        <li>Resize images to fit your layout</li>
                                        <li>Position carefully to avoid overlapping text</li>
                                        <li>Use small images to keep file size manageable</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">Erasing Content</h5>
                                </div>
                                <div class="card-body">
                                    <ul>
                                        <li>Use precise coordinates to target content</li>
                                        <li>Make the area slightly larger than needed</li>
                                        <li>This is permanent and cannot be undone</li>
                                        <li>Use for removing sensitive information</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> PDF editing is limited to adding new content or covering existing content. For more complex editing needs, consider using specialized PDF editing software.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // PDF Preview click handler to set coordinates
        const pdfPreview = document.getElementById('pdf-preview');
        if (pdfPreview) {
            pdfPreview.addEventListener('click', function(e) {
                // Get click coordinates relative to the image
                const rect = pdfPreview.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                // Calculate the scale factor between the preview and actual PDF
                const scaleX = {{ pdf_width }} / pdfPreview.width;
                const scaleY = {{ pdf_height }} / pdfPreview.height;

                // Convert to PDF coordinates
                const pdfX = Math.round(x * scaleX);
                const pdfY = Math.round(y * scaleY);

                // Set the coordinates in the active tab's form
                const activeTab = document.querySelector('.tab-pane.active');
                if (activeTab.id === 'text-panel') {
                    document.getElementById('text-x').value = pdfX;
                    document.getElementById('text-y').value = pdfY;
                } else if (activeTab.id === 'image-panel') {
                    document.getElementById('image-x').value = pdfX;
                    document.getElementById('image-y').value = pdfY;
                } else if (activeTab.id === 'erase-panel') {
                    // For erase, set the top-left corner
                    document.getElementById('erase-x1').value = pdfX;
                    document.getElementById('erase-y1').value = pdfY;
                    // And set the bottom-right corner to be 100x100 pixels larger
                    document.getElementById('erase-x2').value = pdfX + 100;
                    document.getElementById('erase-y2').value = pdfY + 100;
                }

                // Show a marker at the clicked position
                showMarker(x, y);
            });
        }

        // Function to show a marker at the clicked position
        function showMarker(x, y) {
            const overlay = document.getElementById('editor-overlay');
            if (!overlay) return;

            // Clear existing markers
            overlay.innerHTML = '';

            // Create a new marker
            const marker = document.createElement('div');
            marker.className = 'position-marker';
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';

            // Add to overlay
            overlay.appendChild(marker);

            // Remove after 2 seconds
            setTimeout(() => {
                marker.remove();
            }, 2000);
        }

        // Text selection and editing functionality
        const pdfPreview = document.getElementById('pdf-preview');
        const editTextTab = document.getElementById('edit-text-tab');
        const textSelectionInfo = document.getElementById('text-selection-info');
        const noTextSelected = document.getElementById('no-text-selected');
        const selectedTextElement = document.getElementById('selected-text');
        const editTextContent = document.getElementById('edit-text-content');
        const applyTextEdit = document.getElementById('apply-text-edit');

        // Variables to store selection information
        let selectionRect = null;
        let selectedTextAttributes = null;
        let isTextSelectionMode = true; // Enable text selection mode by default
        const debugMode = true; // Set to true to show debug information
        let allTextBlocks = []; // Store all text blocks on the page

        // Set cursor to text mode by default
        if (pdfPreview) {
            pdfPreview.style.cursor = 'text';

            // Load all text blocks on the page when the page loads
            loadAllTextBlocks();
        }

        // Enable text selection mode when the Edit Text tab is clicked
        if (editTextTab) {
            editTextTab.addEventListener('click', function() {
                isTextSelectionMode = true;
                pdfPreview.style.cursor = 'text';
            });
        }

        // Disable text selection mode when other tabs are clicked
        document.querySelectorAll('#editorTabs .nav-link:not(#edit-text-tab)').forEach(tab => {
            tab.addEventListener('click', function() {
                isTextSelectionMode = false;
                pdfPreview.style.cursor = 'default';
            });
        });

        // Handle PDF preview click for text selection
        if (pdfPreview) {
            pdfPreview.addEventListener('click', function(e) {
                if (!isTextSelectionMode) return;

                // Get click coordinates relative to the image
                const rect = pdfPreview.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                // Calculate the scale factor between the preview and actual PDF
                const scaleX = {{ pdf_width }} / pdfPreview.offsetWidth;
                const scaleY = {{ pdf_height }} / pdfPreview.offsetHeight;

                // Convert to PDF coordinates
                const pdfX = x * scaleX;
                const pdfY = y * scaleY;

                // Create a selection rectangle (adjust size as needed)
                // Use a smaller selection area for more precise text selection
                const selectionSize = 30; // Size in PDF coordinates - smaller for more precise selection
                const x1 = Math.max(0, pdfX - selectionSize/2);
                const y1 = Math.max(0, pdfY - selectionSize/2);
                const x2 = Math.min({{ pdf_width }}, pdfX + selectionSize/2);
                const y2 = Math.min({{ pdf_height }}, pdfY + selectionSize/2);

                // Store the selection rectangle
                selectionRect = [x1, y1, x2, y2];

                // Show a visual indicator of the selection
                showSelectionRect(x - selectionSize/2/scaleX, y - selectionSize/2/scaleY,
                                 selectionSize/scaleX, selectionSize/scaleY);

                // Extract text from the selected area
                extractTextFromSelection(selectionRect);

                // Log for debugging
                if (debugMode) {
                    console.log('Click coordinates:', x, y);
                    console.log('PDF coordinates:', pdfX, pdfY);
                    console.log('Selection rectangle:', selectionRect);
                }
            });
        }

        // Function to show a visual indicator of the selection rectangle
        function showSelectionRect(x, y, width, height) {
            const overlay = document.getElementById('editor-overlay');
            if (!overlay) return;

            // Clear previous markers
            overlay.innerHTML = '';

            // Create a selection rectangle
            const selectionElement = document.createElement('div');
            selectionElement.className = 'text-selection-rect';
            selectionElement.style.left = x + 'px';
            selectionElement.style.top = y + 'px';
            selectionElement.style.width = width + 'px';
            selectionElement.style.height = height + 'px';

            // Add to overlay
            overlay.appendChild(selectionElement);
        }

        // Function to load all text blocks on the page
        function loadAllTextBlocks() {
            const formData = new FormData();
            formData.append('filename', '{{ filename }}');
            formData.append('page_number', {{ current_page }});

            fetch('{{ url_for("edit.get_all_text") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading text blocks:', data.error);
                    return;
                }

                // Store all text blocks
                allTextBlocks = data.blocks || [];

                // Debug information
                if (debugMode) {
                    console.log('Loaded text blocks:', allTextBlocks.length);
                    console.log('First few blocks:', allTextBlocks.slice(0, 3));
                }

                // Highlight all text blocks for debugging if needed
                if (debugMode && true) { // Set to true to see all text blocks highlighted
                    highlightAllTextBlocks();
                }
            })
            .catch(error => {
                console.error('Error loading text blocks:', error);
            });
        }

        // Function to highlight all text blocks (for debugging)
        function highlightAllTextBlocks() {
            const overlay = document.getElementById('editor-overlay');
            if (!overlay) return;

            // Clear previous markers
            overlay.innerHTML = '';

            // Calculate the scale factor between the preview and actual PDF
            const scaleX = pdfPreview.offsetWidth / {{ pdf_width }};
            const scaleY = pdfPreview.offsetHeight / {{ pdf_height }};

            // Add a highlight for each text block
            allTextBlocks.forEach((block, index) => {
                const bbox = block.bbox;
                if (!bbox || bbox.length !== 4) return;

                // Convert PDF coordinates to screen coordinates
                const x = bbox[0] * scaleX;
                const y = bbox[1] * scaleY;
                const width = (bbox[2] - bbox[0]) * scaleX;
                const height = (bbox[3] - bbox[1]) * scaleY;

                // Create a highlight element
                const highlight = document.createElement('div');
                highlight.className = 'text-block-highlight';
                highlight.style.left = x + 'px';
                highlight.style.top = y + 'px';
                highlight.style.width = width + 'px';
                highlight.style.height = height + 'px';
                highlight.style.backgroundColor = `rgba(${index % 255}, ${(index * 50) % 255}, ${(index * 100) % 255}, 0.3)`;
                highlight.title = block.text;

                // Add to overlay
                overlay.appendChild(highlight);
            });
        }

        // Function to extract text from the selected area
        function extractTextFromSelection(rect) {
            // If we have all text blocks loaded, find the closest one to the click point
            if (allTextBlocks.length > 0) {
                // Calculate the center point of the selection rectangle
                const center_x = (rect[0] + rect[2]) / 2;
                const center_y = (rect[1] + rect[3]) / 2;

                // Find the closest text block
                let closestBlock = null;
                let closestDistance = Infinity;

                allTextBlocks.forEach(block => {
                    const bbox = block.bbox;
                    if (!bbox || bbox.length !== 4) return;

                    // Calculate the center of the block
                    const block_center_x = (bbox[0] + bbox[2]) / 2;
                    const block_center_y = (bbox[1] + bbox[3]) / 2;

                    // Calculate distance to the click point
                    const distance = Math.sqrt(
                        Math.pow(block_center_x - center_x, 2) +
                        Math.pow(block_center_y - center_y, 2)
                    );

                    // Check if this block is within or very close to the selection rectangle
                    const is_close = (
                        (rect[0] <= block_center_x && block_center_x <= rect[2] &&
                         rect[1] <= block_center_y && block_center_y <= rect[3]) ||
                        distance < 50
                    );

                    if (is_close && distance < closestDistance) {
                        closestBlock = block;
                        closestDistance = distance;
                    }
                });

                if (closestBlock) {
                    // Debug information
                    if (debugMode) {
                        console.log('Found closest block:', closestBlock);
                        console.log('Distance:', closestDistance);
                    }

                    // Store the text attributes for later use
                    selectedTextAttributes = closestBlock;
                    selectionRect = closestBlock.bbox;

                    // Show the extracted text
                    selectedTextElement.textContent = closestBlock.text;
                    editTextContent.value = closestBlock.text;
                    textSelectionInfo.classList.remove('d-none');
                    noTextSelected.classList.add('d-none');

                    // Show a visual indicator of the selection
                    const scaleX = pdfPreview.offsetWidth / {{ pdf_width }};
                    const scaleY = pdfPreview.offsetHeight / {{ pdf_height }};

                    const x = closestBlock.bbox[0] * scaleX;
                    const y = closestBlock.bbox[1] * scaleY;
                    const width = (closestBlock.bbox[2] - closestBlock.bbox[0]) * scaleX;
                    const height = (closestBlock.bbox[3] - closestBlock.bbox[1]) * scaleY;

                    showSelectionRect(x, y, width, height);
                    return;
                }
            }

            // Fallback to the server-side extraction if no close block was found
            const formData = new FormData();
            formData.append('filename', '{{ filename }}');
            formData.append('page_number', {{ current_page }});
            formData.append('x1', rect[0]);
            formData.append('y1', rect[1]);
            formData.append('x2', rect[2]);
            formData.append('y2', rect[3]);

            fetch('{{ url_for("edit.extract_text") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error extracting text:', data.error);
                    return;
                }

                // Store the text attributes for later use
                selectedTextAttributes = data.blocks.length > 0 ? data.blocks[0] : null;

                // Debug information
                if (debugMode) {
                    console.log('Extracted text from server:', data.text);
                    console.log('Text blocks from server:', data.blocks);
                    console.log('Selected attributes from server:', selectedTextAttributes);
                }

                // Show the extracted text
                if (data.text && data.text.trim() !== '') {
                    selectedTextElement.textContent = data.text;
                    editTextContent.value = data.text;
                    textSelectionInfo.classList.remove('d-none');
                    noTextSelected.classList.add('d-none');
                } else {
                    textSelectionInfo.classList.add('d-none');
                    noTextSelected.classList.remove('d-none');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        // Handle apply text edit button
        if (applyTextEdit) {
            applyTextEdit.addEventListener('click', function() {
                if (!selectionRect || !editTextContent.value.trim()) return;

                const formData = new FormData();
                formData.append('filename', '{{ filename }}');
                formData.append('page_number', {{ current_page }});
                formData.append('original_rect', JSON.stringify(selectionRect));
                formData.append('new_text', editTextContent.value);
                formData.append('text_attributes', JSON.stringify(selectedTextAttributes));

                fetch('{{ url_for("edit.replace_text") }}', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error replacing text:', data.error);
                        return;
                    }

                    // Reload the page with the new output filename
                    window.location.href = "{{ url_for('edit.content') }}?filename={{ filename }}&page={{ current_page }}&output=" + data.output_filename;
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        }

        // Navigation buttons
        const prevButton = document.getElementById('prev-page');
        const nextButton = document.getElementById('next-page');

        if (prevButton) {
            prevButton.addEventListener('click', function() {
                const currentPage = parseInt({{ current_page }});
                if (currentPage > 1) {
                    // Preserve output filename if it exists
                    const outputParam = '{{ request.args.get("output") }}' ? '&output={{ request.args.get("output") }}' : '';
                    window.location.href = "{{ url_for('edit.content') }}?filename={{ filename }}&page=" + (currentPage - 1) + outputParam;
                }
            });
        }

        if (nextButton) {
            nextButton.addEventListener('click', function() {
                const currentPage = parseInt({{ current_page }});
                const totalPages = parseInt({{ total_pages }});
                if (currentPage < totalPages) {
                    // Preserve output filename if it exists
                    const outputParam = '{{ request.args.get("output") }}' ? '&output={{ request.args.get("output") }}' : '';
                    window.location.href = "{{ url_for('edit.content') }}?filename={{ filename }}&page=" + (currentPage + 1) + outputParam;
                }
            });
        }

        // Log navigation info for debugging
        console.log('Current page:', {{ current_page }});
        console.log('Total pages:', {{ total_pages }});
        console.log('Prev button disabled:', {{ 'true' if current_page <= 1 else 'false' }});
        console.log('Next button disabled:', {{ 'true' if current_page >= total_pages else 'false' }});

        // Image file preview
        const imageFile = document.getElementById('image-file');
        const imageWidth = document.getElementById('image-width');
        const imageHeight = document.getElementById('image-height');

        if (imageFile) {
            imageFile.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const img = new Image();
                    img.onload = function() {
                        // Set width and height based on the image's natural dimensions
                        // but scale down if too large
                        const maxWidth = {{ pdf_width }};
                        const maxHeight = {{ pdf_height }};

                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            const ratio = maxWidth / width;
                            width = maxWidth;
                            height = height * ratio;
                        }

                        if (height > maxHeight) {
                            const ratio = maxHeight / height;
                            height = maxHeight;
                            width = width * ratio;
                        }

                        imageWidth.value = Math.round(width);
                        imageHeight.value = Math.round(height);
                    };
                    img.src = URL.createObjectURL(this.files[0]);
                }
            });
        }
    });
</script>

<style>
    .pdf-preview-container {
        position: relative;
        overflow: hidden;
    }

    #editor-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 50;
    }

    .position-marker {
        position: absolute;
        width: 10px;
        height: 10px;
        background-color: red;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
    }

    .text-selection-rect {
        position: absolute;
        border: 3px dashed #ff0000;
        background-color: rgba(255, 0, 0, 0.2);
        pointer-events: none;
        z-index: 100;
    }

    .text-block-highlight {
        position: absolute;
        border: 2px solid rgba(0, 0, 255, 0.7);
        background-color: rgba(0, 0, 255, 0.2);
        pointer-events: none;
        z-index: 50;
        box-shadow: 0 0 5px rgba(0, 0, 255, 0.5);
    }
</style>
{% endblock %}
