{% extends 'base.html' %}

{% block title %}Processing Authentication{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success">
                    <h4 class="mb-0 text-white">Processing Authentication</h4>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <div class="spinner-border text-success mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p id="status-message">Please wait while we complete your authentication...</p>
                        <pre id="debug-info" class="mt-3 text-start" style="font-size: 0.8rem; background-color: #f8f9fa; padding: 10px; border-radius: 5px;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Execute immediately without waiting for DOMContentLoaded
    console.log('OAuth callback page loaded');

    // Display the current URL for debugging
    document.getElementById('debug-info').textContent = 'Current URL: ' + window.location.href;

    // Function to process the access token
    function processAccessToken() {
        console.log('Processing access token...');

        // Check if there's an access token in the URL fragment
        if (window.location.hash && window.location.hash.includes('access_token=')) {
            console.log('Access token found in URL fragment');
            document.getElementById('status-message').textContent = 'Access token found, processing...';

            try {
                // Parse the hash fragment
                const hashParams = {};
                window.location.hash.substring(1).split('&').forEach(pair => {
                    if (pair && pair.includes('=')) {
                        const [key, value] = pair.split('=');
                        hashParams[key] = decodeURIComponent(value);
                    }
                });

                console.log('Hash params keys:', Object.keys(hashParams));
                document.getElementById('debug-info').textContent += '\nHash params keys: ' + Object.keys(hashParams).join(', ');

                // Check if we have an access token
                if (hashParams.access_token) {
                    console.log('Access token found, redirecting to dashboard...');
                    document.getElementById('status-message').textContent = 'Access token found, redirecting to dashboard...';

                    // Redirect to the dashboard with the access token as a query parameter
                    window.location.href = '/auth/dashboard?access_token=' + encodeURIComponent(hashParams.access_token);
                } else {
                    console.error('No access token found in hash params');
                    document.getElementById('status-message').textContent = 'No access token found, redirecting to login...';
                    window.location.href = '/auth/login?error=no_access_token';
                }
            } catch (error) {
                console.error('Error processing hash fragment:', error);
                document.getElementById('status-message').textContent = 'Error processing authentication, redirecting to login...';
                window.location.href = '/auth/login?error=processing_error';
            }
        } else {
            console.log('No access token in URL fragment');
            document.getElementById('status-message').textContent = 'No access token found, redirecting to login...';
            window.location.href = '/auth/login?error=no_access_token';
        }
    }

    // Call the function immediately
    processAccessToken();

    // Also call it when the page is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded, processing access token again...');
        processAccessToken();
    });
</script>
{% endblock %}
