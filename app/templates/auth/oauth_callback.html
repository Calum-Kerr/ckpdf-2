{% extends 'base.html' %}

{% block title %}Processing Authentication{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success">
                    <h4 class="mb-0 text-white">Processing Authentication</h4>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <div class="spinner-border text-success mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p id="status-message">Please wait while we complete your authentication...</p>
                        <pre id="debug-info" class="mt-3 text-start" style="font-size: 0.8rem; background-color: #f8f9fa; padding: 10px; border-radius: 5px;"></pre>
                    </div>

                    <div class="mt-4">
                        <h5>Manual Authentication</h5>
                        <p>If automatic authentication doesn't work, you can try manual authentication:</p>
                        <div id="token-info" class="alert alert-info" style="display: none;">
                            <p>Access token found in URL. Click the button below to authenticate.</p>
                            <button id="manual-auth-btn" class="btn btn-primary">Authenticate Manually</button>
                        </div>
                        <div id="no-token-info" class="alert alert-warning" style="display: none;">
                            <p>No access token found in URL.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ request.csp_nonce }}">
    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('OAuth callback page loaded');

        // Display the current URL for debugging
        const debugInfo = document.getElementById('debug-info');
        const statusMessage = document.getElementById('status-message');
        const tokenInfo = document.getElementById('token-info');
        const noTokenInfo = document.getElementById('no-token-info');
        const manualAuthBtn = document.getElementById('manual-auth-btn');

        debugInfo.textContent = 'Current URL: ' + window.location.href;

        // Function to parse hash parameters
        function parseHashParams() {
            const hashParams = {};
            if (window.location.hash && window.location.hash.length > 1) {
                window.location.hash.substring(1).split('&').forEach(pair => {
                    if (pair && pair.includes('=')) {
                        const [key, value] = pair.split('=');
                        hashParams[key] = decodeURIComponent(value);
                    }
                });
            }
            return hashParams;
        }

        // Function to authenticate with token
        function authenticateWithToken(token, refreshToken, expiresIn, providerToken) {
            console.log('Authenticating with token...');
            statusMessage.textContent = 'Authenticating with token...';

            // Create data object
            const data = {
                access_token: token
            };

            if (refreshToken) {
                data.refresh_token = refreshToken;
            }

            if (expiresIn) {
                data.expires_in = expiresIn;
            }

            if (providerToken) {
                data.provider_token = providerToken;
            }

            // Use fetch API to send the token directly
            fetch('/auth/process-token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response.redirected) {
                    // If the server redirected us, follow the redirect
                    window.location.href = response.url;
                } else if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Authentication failed: ' + response.status);
                }
            })
            .then(data => {
                if (data && data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    statusMessage.textContent = 'Authentication successful, but no redirect URL provided.';
                }
            })
            .catch(error => {
                console.error('Error during authentication:', error);
                debugInfo.textContent += '\nError during authentication: ' + error.message;
                statusMessage.textContent = 'Error during authentication. Please try the manual authentication button below.';
            });
        }

        // Check if there's an access token in the URL fragment
        const hashParams = parseHashParams();
        debugInfo.textContent += '\nHash params: ' + JSON.stringify(hashParams, null, 2);

        if (hashParams.access_token) {
            console.log('Access token found in URL fragment');
            debugInfo.textContent += '\nAccess token found: ' + hashParams.access_token.substring(0, 10) + '...';
            statusMessage.textContent = 'Access token found, processing...';

            // Show the token info section
            tokenInfo.style.display = 'block';

            // Set up manual authentication button
            manualAuthBtn.addEventListener('click', function() {
                authenticateWithToken(
                    hashParams.access_token,
                    hashParams.refresh_token,
                    hashParams.expires_in,
                    hashParams.provider_token
                );
            });

            // Try automatic authentication using the form submission instead of redirect
            // This is more reliable across browsers and handles the token more securely
            try {
                console.log('Attempting automatic authentication...');
                authenticateWithToken(
                    hashParams.access_token,
                    hashParams.refresh_token,
                    hashParams.expires_in,
                    hashParams.provider_token
                );
            } catch (error) {
                console.error('Error during automatic authentication:', error);
                debugInfo.textContent += '\nError during automatic authentication: ' + error.message;
                statusMessage.textContent = 'Error during automatic authentication. Please try the manual authentication button below.';
            }
        } else {
            console.log('No access token in URL fragment');
            debugInfo.textContent += '\nNo access token found in URL fragment';
            statusMessage.textContent = 'No access token found. Please try logging in again.';

            // Show the no token info section
            noTokenInfo.style.display = 'block';
        }
    });
</script>
{% endblock %}
