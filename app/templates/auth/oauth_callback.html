{% extends 'base.html' %}

{% block title %}Processing Authentication{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success">
                    <h4 class="mb-0 text-white">Processing Authentication</h4>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <div class="spinner-border text-success mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p id="status-message">Please wait while we complete your authentication...</p>
                        <pre id="debug-info" class="mt-3 text-start" style="font-size: 0.8rem; background-color: #f8f9fa; padding: 10px; border-radius: 5px;"></pre>
                    </div>

                    <div class="mt-4">
                        <h5>Manual Authentication</h5>
                        <p>If automatic authentication doesn't work, you can try manual authentication:</p>
                        <div id="token-info" class="alert alert-info" style="display: none;">
                            <p>Access token found in URL. Click the button below to authenticate.</p>
                            <button id="manual-auth-btn" class="btn btn-primary">Authenticate Manually</button>
                        </div>
                        <div id="no-token-info" class="alert alert-warning" style="display: none;">
                            <p>No access token found in URL.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ request.csp_nonce }}">
    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('OAuth callback page loaded');

        // Display the current URL for debugging
        const debugInfo = document.getElementById('debug-info');
        const statusMessage = document.getElementById('status-message');
        const tokenInfo = document.getElementById('token-info');
        const noTokenInfo = document.getElementById('no-token-info');
        const manualAuthBtn = document.getElementById('manual-auth-btn');

        debugInfo.textContent = 'Current URL: ' + window.location.href;

        // Function to parse hash parameters
        function parseHashParams() {
            const hashParams = {};
            if (window.location.hash && window.location.hash.length > 1) {
                window.location.hash.substring(1).split('&').forEach(pair => {
                    if (pair && pair.includes('=')) {
                        const [key, value] = pair.split('=');
                        hashParams[key] = decodeURIComponent(value);
                    }
                });
            }
            return hashParams;
        }

        // Function to authenticate with token
        function authenticateWithToken(token, refreshToken, expiresIn, providerToken) {
            console.log('Authenticating with token...');
            statusMessage.textContent = 'Authenticating with token...';

            // Create a form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/auth/process-token';
            form.style.display = 'none';

            // Add CSRF token - this is needed for Flask-WTF
            const csrfToken = "{{ csrf_token() }}";
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);

            // Add token data
            const tokenInput = document.createElement('input');
            tokenInput.type = 'hidden';
            tokenInput.name = 'access_token';
            tokenInput.value = token;
            form.appendChild(tokenInput);

            // Add additional token data if available
            if (refreshToken) {
                const refreshInput = document.createElement('input');
                refreshInput.type = 'hidden';
                refreshInput.name = 'refresh_token';
                refreshInput.value = refreshToken;
                form.appendChild(refreshInput);
            }

            if (expiresIn) {
                const expiresInput = document.createElement('input');
                expiresInput.type = 'hidden';
                expiresInput.name = 'expires_in';
                expiresInput.value = expiresIn;
                form.appendChild(expiresInput);
            }

            if (providerToken) {
                const providerInput = document.createElement('input');
                providerInput.type = 'hidden';
                providerInput.name = 'provider_token';
                providerInput.value = providerToken;
                form.appendChild(providerInput);
            }

            // Add the form to the document and submit it
            document.body.appendChild(form);
            console.log('Submitting form to process token...');
            form.submit();
        }

        // Check if there's an access token in the URL fragment
        const hashParams = parseHashParams();
        debugInfo.textContent += '\nHash params: ' + JSON.stringify(hashParams, null, 2);

        if (hashParams.access_token) {
            console.log('Access token found in URL fragment');
            debugInfo.textContent += '\nAccess token found: ' + hashParams.access_token.substring(0, 10) + '...';
            statusMessage.textContent = 'Access token found, processing...';

            // Show the token info section
            tokenInfo.style.display = 'block';

            // Set up manual authentication button
            manualAuthBtn.addEventListener('click', function() {
                authenticateWithToken(
                    hashParams.access_token,
                    hashParams.refresh_token,
                    hashParams.expires_in,
                    hashParams.provider_token
                );
            });

            // Try automatic authentication using the form submission instead of redirect
            // This is more reliable across browsers and handles the token more securely
            try {
                console.log('Attempting automatic authentication...');
                authenticateWithToken(
                    hashParams.access_token,
                    hashParams.refresh_token,
                    hashParams.expires_in,
                    hashParams.provider_token
                );
            } catch (error) {
                console.error('Error during automatic authentication:', error);
                debugInfo.textContent += '\nError during automatic authentication: ' + error.message;
                statusMessage.textContent = 'Error during automatic authentication. Please try the manual authentication button below.';
            }
        } else {
            console.log('No access token in URL fragment');
            debugInfo.textContent += '\nNo access token found in URL fragment';
            statusMessage.textContent = 'No access token found. Please try logging in again.';

            // Show the no token info section
            noTokenInfo.style.display = 'block';
        }
    });
</script>
{% endblock %}
